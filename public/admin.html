<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é™¢æ„è§åé¦ˆç®¡ç†ç³»ç»Ÿ</title>
<link rel="icon" href="/logo.png" type="image/png">    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        body { 
            background-color: #F1F5F9; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
            color: #334155;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        
        .sidebar-item { 
            border-left: 3px solid transparent; 
            position: relative;
            overflow: hidden;
        }
        .sidebar-item:hover { 
            background-color: #1E293B; 
            color: #E2E8F0; 
            transform: translateX(2px);
        }
        .nav-active { 
            background-color: #0F766E !important; 
            color: white !important; 
            border-left: 3px solid #2DD4BF; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateX(0);
        }
        .nav-active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #2DD4BF 0%, #0F766E 100%);
        }
        
        .card-gradient-1 { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #F97316 0%, #EA580C 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); }

        [v-cloak] { display: none; }

        @media (max-width: 768px) {
            .text-xs { font-size: 14px; line-height: 1.5; }
            .text-sm { font-size: 16px; line-height: 1.5; }
            .text-base { font-size: 17px; line-height: 1.6; }
            .text-lg { font-size: 19px; line-height: 1.6; }
            .text-xl { font-size: 21px; line-height: 1.6; }
            .text-2xl { font-size: 24px; line-height: 1.7; }
            .text-3xl { font-size: 28px; line-height: 1.7; }
            .text-slate-400 { font-size: 14px; }
            .text-slate-500 { font-size: 15px; }
            button { font-size: 16px; }
            input, textarea { font-size: 16px; }
            p { line-height: 1.6; }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex">

<div id="app" v-cloak class="w-full h-full flex">
    

    <div v-if="!isLoggedIn" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-[400px] animate__animated animate__fadeInUp">
            <div class="flex flex-col items-center mb-8">
                <div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center mb-4 shadow-inner">
                    <img src="./logo.png" class="w-full h-full object-contain p-2">
                </div>
                <h2 class="text-xl font-black text-slate-800 tracking-tight">ç®¡ç†åå°ç™»å½•</h2>
                <p class="text-sm text-slate-400 mt-1">ä¸‰æ±Ÿå¿äººæ°‘åŒ»é™¢ Â· æ„è§åé¦ˆä¸­å¿ƒ</p>
            </div>
            <div class="space-y-4">
                <input type="password" v-model="password" @keyup.enter="login" class="w-full border border-slate-200 bg-slate-50 rounded-xl p-4 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all text-center tracking-widest text-lg" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <button @click="login" class="w-full bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white py-4 rounded-xl font-bold shadow-lg shadow-teal-500/30 transition-all active:scale-95">
                    è¿›å…¥ç³»ç»Ÿ
                </button>
            </div>
        </div>
    </div>


    <template v-else>
        <aside class="w-64 bg-[#0F172A] text-slate-400 flex flex-col shrink-0 shadow-xl z-20">
            <div class="h-20 flex items-center px-6 border-b border-slate-800 bg-[#0F172A] shrink-0 gap-4">
                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                    <img src="./logo.png" class="w-12 h-12 object-contain">
                </div>
                <div>
                    <h1 class="font-black text-white text-lg leading-tight">ä¸‰æ±Ÿå¿äººæ°‘åŒ»é™¢<br/>åé¦ˆç®¡ç†ç³»ç»Ÿ</h1>
                    <p class="text-[11px] opacity-60 uppercase tracking-wider font-medium">Admin Panel</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-6 space-y-4">
                <div class="px-3">
                    <button @click="resetFilter" 
                        class="w-full text-left px-4 py-3.5 rounded-xl text-sm font-semibold leading-relaxed flex justify-between items-center transition-all sidebar-item"
                        :class="currentFilter === 'all' ? 'nav-active' : ''">
                        <span class="flex items-center gap-3"><i class="fa-solid fa-chart-pie w-4 text-center"></i> ç»¼åˆçœ‹æ¿</span>
                        <span v-if="list.length > 0" class="text-[11px] bg-white/10 px-2 py-0.5 rounded-md text-white font-mono font-bold">{{ list.length }}</span>
                    </button>
                </div>

                <div v-for="(items, group) in deptGroups" :key="group">
                    <div class="px-6 mb-4 text-xs font-black uppercase tracking-wider text-slate-300 flex justify-between items-center group cursor-pointer hover:text-slate-300 transition-colors" @click="filterByGroup(group)">
                        <span class="flex items-center gap-2">
                            <span class="w-1.5 h-4 bg-teal-500 rounded-full opacity-60"></span>
                            {{ group }}
                        </span>
                        <i class="fa-solid fa-chevron-right text-[8px] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </div>
                    <div class="px-3 space-y-1.5">
                        <button v-for="dept in items" :key="dept" 
                            @click="filterByDept(dept)"
                            class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold leading-relaxed transition-all flex justify-between items-center sidebar-item"
                            :class="currentFilter === dept ? 'nav-active' : ''">
                            <span class="truncate">{{ dept }}</span>
                            <span v-if="getCount(dept) > 0" class="text-[11px] bg-white/10 px-2 py-0.5 rounded-md text-white font-mono font-bold">{{ getCount(dept) }}</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-[#0F172A] shrink-0">
                <button @click="logout" class="w-full flex items-center justify-center gap-2 text-rose-400 hover:text-white hover:bg-rose-500/20 py-3 rounded-xl transition-all text-xs font-bold">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> å®‰å…¨é€€å‡º
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-[#F1F5F9] relative overflow-hidden">
            <header class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-8 shrink-0 sticky top-0 z-10">
                <h2 class="font-bold text-slate-800 flex items-center gap-3 text-lg">
                    <span v-if="currentFilter === 'all'" class="flex items-center gap-2"><i class="fa-solid fa-house text-teal-600"></i> å…¨é™¢æ¦‚è§ˆ</span>
                    <span v-else-if="currentGroup" class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-600"></i> {{ currentGroup }}</span>
                    <span v-else class="flex items-center gap-2"><i class="fa-solid fa-hospital text-indigo-600"></i> {{ currentFilter }}</span>
                    <i v-if="isLoading" class="fa-solid fa-circle-notch fa-spin text-slate-400 ml-2 text-xs"></i>
                </h2>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="healthStatus === 'healthy' ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></span>
                        <span class="text-xs text-slate-400 font-mono bg-slate-100 px-3 py-1 rounded-full">ä¸Šæ¬¡æ›´æ–°: {{ lastUpdateTime }}</span>
                    </div>
                    <button @click="load(true)" class="w-9 h-9 rounded-full bg-white border border-slate-200 hover:bg-slate-50 hover:text-teal-600 flex items-center justify-center transition-all shadow-sm text-slate-400">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">åé¦ˆæ€»æ•°</div>
                            <div class="text-3xl font-black text-slate-800">{{ filteredList.length }}</div>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-blue-600 bg-blue-50 w-fit px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-inbox"></i> å…¨éƒ¨è®°å½•
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">æ”¶åˆ°è¡¨æ‰¬</div>
                            <div class="text-3xl font-black text-emerald-600">{{ stats.commendation }}</div>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-emerald-600 bg-emerald-50 w-fit px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-heart"></i> å æ¯” {{ stats.commendationRate }}%
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-orange-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">æ”¶åˆ°æŠ•è¯‰</div>
                            <div class="text-3xl font-black text-orange-600">{{ stats.complaint }}</div>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-orange-600 bg-orange-50 w-fit px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-triangle-exclamation"></i> éœ€é‡ç‚¹å…³æ³¨
                            </div>
                        </div>
                    </div>

                    <div class="text-white rounded-2xl p-5 shadow-lg shadow-indigo-500/20 card-gradient-4 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-white opacity-10 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="text-indigo-100 text-xs font-bold uppercase tracking-wider mb-1">ä»Šæ—¥æ–°å¢</div>
                            <div class="text-3xl font-black">{{ todayCount }}</div>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-white bg-white/20 w-fit px-2 py-1 rounded-lg backdrop-blur-sm">
                                <i class="fa-regular fa-clock"></i> å®æ—¶ç›‘æ§ä¸­
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 w-full text-left">æ»¡æ„åº¦å æ¯”</h3>
                        <div class="w-48 h-48 relative">
                            <canvas id="chartRatio"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-2xl font-black text-slate-700">{{ stats.commendationRate }}%</span>
                                <span class="text-[10px] text-slate-400 uppercase">æ»¡æ„ç‡</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-2">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">ç§‘å®¤åé¦ˆåˆ†å¸ƒ (Top 8)</h3>
                        <div class="h-48 w-full">
                            <canvas id="chartDept"></canvas>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h3 class="font-bold text-slate-700">ğŸ“‹ è¯¦ç»†è®°å½•</h3>
                        <div class="text-xs text-slate-400">å…± {{ filteredList.length }} æ¡è®°å½•</div>
                    </div>

                    <div v-if="filteredList.length === 0" class="bg-white rounded-2xl p-12 text-center border border-slate-100 border-dashed">
                        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                            <i class="fa-solid fa-inbox"></i>
                        </div>
                        <p class="text-slate-400 text-sm">æš‚æ— ç›¸å…³æ•°æ®ï¼Œå–æ¯å’–å•¡ä¼‘æ¯ä¸€ä¸‹å§ â˜•ï¸</p>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        <div v-for="item in filteredList" :key="item.id" 
                             @click="openModal(item)"
                             class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm hover:shadow-md hover:border-teal-200 transition-all cursor-pointer group relative">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 rounded-md text-[10px] font-bold border flex items-center gap-1"
                                          :class="item.type === 'commendation' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-orange-50 text-orange-600 border-orange-100'">
                                        <i :class="item.type === 'commendation' ? 'fa-solid fa-heart' : 'fa-solid fa-circle-exclamation'"></i>
                                        {{ item.type === 'commendation' ? 'è¡¨æ‰¬' : 'æŠ•è¯‰' }}
                                    </span>
                                    <h4 class="font-bold text-slate-700 text-sm truncate max-w-[150px]">{{ item.department }}</h4>
                                </div>
                                <span class="text-[10px] text-slate-400 font-mono">{{ formatTime(item.created_at) }}</span>
                            </div>

                            <p class="text-xs text-slate-500 line-clamp-2 leading-relaxed mb-3 pl-1 border-l-2 border-slate-100 group-hover:border-teal-400 transition-colors">
                                {{ item.description }}
                            </p>

                            <div class="flex items-center justify-between border-t border-slate-50 pt-3">
                                <div class="flex items-center gap-3 text-[10px] text-slate-400 font-medium">
                                    <span class="bg-slate-50 px-2 py-0.5 rounded">{{ item.target_role }} {{ item.target_name }}</span>
                                    <span><i class="fa-regular fa-user mr-1"></i>{{ item.submitter_name || 'åŒ¿å' }}</span>
                                </div>
                                <button @click.stop="deleteItem(item.id)" class="w-6 h-6 rounded flex items-center justify-center text-slate-300 hover:bg-red-50 hover:text-red-500 transition-colors">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>

                            <div v-if="isNew(item.created_at)" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full m-2 shadow-sm animate-pulse"></div>
                        </div>
                    </div>
                </div>
                
                <div class="h-10"></div>
            </div>
        </main>
    </template>


    <div v-if="showModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate__animated animate__fadeIn" @click.self="showModal=false">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate__animated animate__zoomIn">
            <div class="p-6 text-white flex justify-between items-start" 
                 :class="curItem.type === 'commendation' ? 'card-gradient-2' : 'card-gradient-3'">
                <div>
                    <div class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-1">Feedback Detail</div>
                    <h3 class="text-2xl font-bold flex items-center gap-2">
                        {{ curItem.department }}
                        <span class="text-xs bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm font-normal">{{ curItem.target_role }}</span>
                    </h3>
                </div>
                <button @click="showModal=false" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors">âœ•</button>
            </div>

            <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <span class="text-[10px] text-slate-400 font-bold uppercase block mb-1">å…·ä½“å¯¹è±¡</span>
                        <div class="font-bold text-slate-800">{{ curItem.target_name || 'æœªå¡«å†™' }}</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <span class="text-[10px] text-slate-400 font-bold uppercase block mb-1">æäº¤æ—¶é—´</span>
                        <div class="font-bold text-slate-800 text-xs font-mono mt-0.5">{{ formatTime(curItem.created_at) }}</div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">å†…å®¹</h4>
                    <div class="text-sm text-slate-600 leading-7 bg-slate-50 p-4 rounded-xl border border-slate-100 whitespace-pre-wrap">{{ curItem.description }}</div>
                </div>
                                <div class="pt-2">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <span class="text-[10px] text-indigo-400 font-bold uppercase block mb-2">æäº¤äººä¿¡æ¯</span>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-user text-indigo-400 text-sm w"></i>
                                <span class="text-slate-700 font-medium">{{ curItem.submitter_name || 'æœªå¡«å†™' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-phone text-indigo-400 text-sm w-5"></i>
                                <span class="text-slate-700 font-medium">{{ curItem.submitter_phone || 'æœªå¡«å†™' }}</span>
                                <a v-if="curItem.submitter_phone" :href="'tel:'+curItem.submitter_phone" class="ml-auto bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-700 transition-all">
                                    <i class="fa-solid fa-phone mr-1"></i> æ‹¨æ‰“
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                <span class="text-[10px] text-slate-400 font-mono">ID: {{ curItem.id }} Â· IP: {{ curItem.ip_address }}</span>
                <button @click="deleteItem(curItem.id)" class="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors">
                    åˆ é™¤æ­¤è®°å½•
                </button>
            </div>
        </div>
    </div>



    <!-- é€šçŸ¥å¼¹çª— -->
    <div class="fixed bottom-8 right-8 z-[100] flex flex-col gap-3 pointer-events-none">
        <transition-group enter-active-class="animate__animated animate__bounceInRight" leave-active-class="animate__animated animate__fadeOutRight">
            <div v-for="toast in toasts" :key="toast.id" class="pointer-events-auto bg-white border-l-4 rounded-xl shadow-2xl p-5 flex items-start gap-4 w-96 ring-1 ring-black/5 animate__animated animate__slideInUp" 
                 :class="toast.type === 'è¡¨æ‰¬' ? 'border-emerald-500' : 'border-orange-500'">
                <div class="rounded-full w-10 h-10 flex items-center justify-center shrink-0 text-xl animate__animated animate__rubberBand"
                    :class="toast.type === 'è¡¨æ‰¬' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'">
                    <i :class="toast.type === 'è¡¨æ‰¬' ? 'fa-solid fa-heart' : 'fa-solid fa-exclamation-triangle'"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        æ”¶åˆ°æ–°åé¦ˆï¼
                    </h4>
                    <p class="text-sm text-gray-500 mt-1">{{ toast.department }} - <span class="font-bold" :class="toast.type === 'è¡¨æ‰¬' ? 'text-emerald-600' : 'text-orange-600'">{{ toast.type }}</span></p>
                </div>
                <button @click="removeToast(toast.id)" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
        </transition-group>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, onUnmounted, nextTick, watch } = Vue;
    createApp({
        setup() {
            const deptGroups = {
                "é—¨è¯ŠåŠæ”¶è´¹": ["é—¨è¯Šéƒ¨", "é—¨è¯Šæ”¶è´¹å¤„", "ä½é™¢æ”¶è´¹å¤„", "æ€¥è¯ŠåŒ»å­¦ç§‘", "åŒ»ä¿åŠ"],
                "å¤–ç§‘ç³»ç»Ÿ": ["æ™®é€šå¤–ç§‘", "æ³Œå°¿å¤–ç§‘", "ç¥ç»å¤–ç§‘", "éª¨ç§‘ä¸€ç—…åŒº", "éª¨ç§‘äºŒç—…åŒº", "éº»é†‰ç§‘"],
                "å†…ç§‘ç³»ç»Ÿ": ["å‘¼å¸å†…ç§‘", "å¿ƒè¡€ç®¡å†…ç§‘", "æ¶ˆåŒ–å†…ç§‘", "ç¥ç»å†…ç§‘", "è‚¿ç˜¤ç§‘", "æ„ŸæŸ“æ€§ç–¾ç—…ç§‘"],
                "å¦‡å„¿ç§‘å®¤": ["å¦‡äº§ç§‘", "å„¿ç§‘"],
                "ä¸“ç§‘é—¨è¯Š": ["å£è…”ç§‘", "çœ¼ç§‘", "è€³é¼»å–‰ç§‘", "ä¸­åŒ»ç§‘", "åº·å¤ç§‘", "ä½“æ£€ç§‘"],
                "åŒ»æŠ€ç§‘å®¤": ["æ£€éªŒç§‘", "è¡€åº“", "è¶…å£°ç§‘", "æ”¾å°„ç§‘", "è¯å‰‚ç§‘"],
                "é‡ç—‡ç›‘æŠ¤": ["é‡ç—‡åŒ»å­¦ç§‘"],
                "å…¶ä»–ç§‘å®¤": ["ä¿å«ç§‘", "è¡Œæ”¿åå‹¤", "å…¶ä»–"]
            };

            const isLoggedIn = ref(false);
            const password = ref('');
            const list = ref([]);
            const currentFilter = ref('all');
            const currentGroup = ref('');
            const isLoading = ref(false);
            const showModal = ref(false);
            const curItem = ref({});
            const lastUpdateTime = ref('');
            const toasts = ref([]);
            const healthStatus = ref('healthy');
            let pollInterval = null;
            let lastMaxId = 0;
            let chartRatio = null;
            let chartDept = null;

            onMounted(() => {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    isLoggedIn.value = true;
                    load();
                    startPolling();
                }
            });

            onUnmounted(() => { 
                if(pollInterval) clearInterval(pollInterval); 
            });

            const login = async () => {
                try {
                    const res = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ password: password.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        localStorage.setItem('admin_token', data.token);
                        isLoggedIn.value = true;
                        load();
                    } else { 
                        alert('å¯†ç é”™è¯¯'); 
                    }
                } catch (e) { 
                    alert('ç™»å½•å¤±è´¥'); 
                }
            };

            const logout = () => {
                localStorage.removeItem('admin_token');
                isLoggedIn.value = false;
                list.value = [];
            };

            const load = async (silent = false) => {
                if (!silent) isLoading.value = true;
                const token = localStorage.getItem('admin_token');
                try {
                    const res = await fetch('/api/admin/list', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (res.status === 403) { 
                        logout(); 
                        return; 
                    }
                    if (res.ok) {
                        const data = await res.json();
                        
                        if(list.value.length > 0 && data.length > list.value.length) {
                            const newItems = data.filter(d => d.id > lastMaxId);
                            if(newItems.length > 0) {
                                playNotificationSound();
                                setTimeout(() => {
                                    newItems.forEach(item => { 
                                        if(lastMaxId > 0) showToast(item); 
                                    });
                                }, 100);
                            }
                        }
                        
                        list.value = data;
                        if(data.length > 0) lastMaxId = Math.max(...data.map(i => i.id));
                        
                        lastUpdateTime.value = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                        healthStatus.value = 'healthy';
                        
                        if(!silent) nextTick(() => initCharts());
                        else updateCharts();
                    } else {
                        healthStatus.value = 'error';
                    }
                } catch (e) { 
                    console.error(e); 
                    healthStatus.value = 'error';
                } 
                finally { 
                    isLoading.value = false; 
                }
            };

            const startPolling = () => { 
                pollInterval = setInterval(() => { 
                    load(true); 
                }, 5000); 
            };

            const resetFilter = () => { 
                currentFilter.value = 'all'; 
                currentGroup.value = ''; 
            };
            
            const filterByGroup = (group) => { 
                currentGroup.value = group; 
                currentFilter.value = ''; 
            };
            
            const filterByDept = (dept) => { 
                currentFilter.value = dept; 
                currentGroup.value = ''; 
            };

            const filteredList = computed(() => {
                let res = list.value;
                if (currentFilter.value && currentFilter.value !== 'all') {
                    res = res.filter(i => i.department === currentFilter.value);
                } else if (currentGroup.value) {
                    const groupDepts = deptGroups[currentGroup.value];
                    res = res.filter(i => groupDepts.includes(i.department));
                }
                return res;
            });

            const stats = computed(() => {
                const total = filteredList.value.length;
                const comm = filteredList.value.filter(i => i.type === 'commendation').length;
                const comp = filteredList.value.filter(i => i.type === 'complaint').length;
                return {
                    commendation: comm,
                    complaint: comp,
                    commendationRate: total > 0 ? ((comm / total) * 100).toFixed(0) : 0
                };
            });

            const todayCount = computed(() => {
                const today = new Date().toDateString();
                return list.value.filter(i => new Date(i.created_at).toDateString() === today).length;
            });

            const initCharts = () => {
                const ctxRatio = document.getElementById('chartRatio');
                const ctxDept = document.getElementById('chartDept');
                
                if(!ctxRatio || !ctxDept) return;

                if(chartRatio) chartRatio.destroy();
                if(chartDept) chartDept.destroy();

                chartRatio = new Chart(ctxRatio, {
                    type: 'doughnut',
                    data: {
                        labels: ['è¡¨æ‰¬', 'æŠ•è¯‰'],
                        datasets: [{
                            data: [stats.value.commendation, stats.value.complaint],
                            backgroundColor: ['#10B981', '#F97316'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        cutout: '75%',
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                const deptCounts = {};
                filteredList.value.forEach(i => {
                    deptCounts[i.department] = (deptCounts[i.department] || 0) + 1;
                });
                const sortedDepts = Object.entries(deptCounts)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 8);

                chartDept = new Chart(ctxDept, {
                    type: 'bar',
                    data: {
                        labels: sortedDepts.map(i => i[0]),
                        datasets: [{
                            label: 'åé¦ˆæ•°é‡',
                            data: sortedDepts.map(i => i[1]),
                            backgroundColor: '#3B82F6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } },
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            };

            const updateCharts = () => {
                if(!chartRatio || !chartDept) return;
                
                chartRatio.data.datasets[0].data = [stats.value.commendation, stats.value.complaint];
                chartRatio.update();
                const deptCounts = {};
                filteredList.value.forEach(i => { 
                    deptCounts[i.department] = (deptCounts[i.department] || 0) + 1; 
                });
                const sortedDepts = Object.entries(deptCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
                chartDept.data.labels = sortedDepts.map(i => i[0]);
                chartDept.data.datasets[0].data = sortedDepts.map(i => i[1]);
                chartDept.update();
            };

            watch([filteredList], () => { updateCharts(); });

            const deleteItem = async (id) => {
                if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
                const token = localStorage.getItem('admin_token');
                await fetch(`/api/admin/delete/${id}`, { method:'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                showModal.value = false;
                load(true);
            };

            const openModal = (item) => { 
                curItem.value = item; 
                showModal.value = true; 
            };
            
            const getCount = (deptName) => list.value.filter(i => i.department === deptName).length;
            
            const formatTime = (t) => {
                const date = new Date(t);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const isNew = (t) => (new Date() - new Date(t)) < 1000 * 60 * 10;
            
            const showToast = (item) => { 
                const id = Date.now(); 
                toasts.value.push({ 
                    id, 
                    department: item.department, 
                    type: item.type === 'commendation' ? 'è¡¨æ‰¬' : 'æŠ•è¯‰'
                }); 
                setTimeout(() => removeToast(id), 5000); 
            };
            
            const removeToast = (id) => { 
                toasts.value = toasts.value.filter(t => t.id !== id); 
            };
            


            const playNotificationSound = () => {
                try {
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2867/2867-preview.mp3');
                    audio.volume = 0.5;
                    audio.play().catch(e => {
                        console.log('Audio play failed:', e);
                        const fallbackAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                        fallbackAudio.play().catch(() => {});
                    });
                } catch (e) {
                    console.log('Audio creation failed:', e);
                }
            };

            return {
                isLoggedIn, password, login, logout, deptGroups, 
                list, filteredList, currentFilter, currentGroup, 
                filterByGroup, filterByDept, resetFilter,
                getCount, isLoading, load, lastUpdateTime, healthStatus,
                showModal, curItem, openModal, deleteItem,
                stats, todayCount, formatTime, isNew, toasts, removeToast
            };
        }
    }).mount('#app');
</script>
</body>
</html>